<!-- 覆盖旧事件逻辑：去掉“必须 token”，并做输入记忆（固定弹框问题） -->
<script>
(function () {
  // ---------- 工具 ----------
  const $ = (s) => document.querySelector(s);
  const LS = {
    get: (k, d='') => { try { return localStorage.getItem(k) ?? d; } catch(e){ return d; } },
    set: (k, v)   => { try { localStorage.setItem(k, v); } catch(e){} }
  };
  function normalizeWss(raw) {
    if (!raw) return '';
    try {
      const u = raw.startsWith('ws') ? new URL(raw)
        : new URL(`wss://${raw.replace(/^\/+/, '')}`);
      return u.toString();
    } catch(e) {
      return raw.trim();
    }
  }
  function safeConnect(which, finalUrl) {
    // 优先走你 app.js 暴露的方法；否则直接 new WebSocket
    if (which === 'src' && typeof window.connectSource === 'function') {
      window.connectSource(finalUrl);
    } else if (which === 'pub' && typeof window.connectPublisher === 'function') {
      window.connectPublisher(finalUrl);
    } else {
      const key = which === 'src' ? 'srcWS' : 'pubWS';
      try { window[key]?.close?.(); } catch(e){}
      window[key] = new WebSocket(finalUrl);
    }
  }

  // ---------- DOM ----------
  const rawUrl   = $('#rawUrl');
  const rawToken = $('#rawToken');
  const pubUrl   = $('#pubUrl');
  const pubToken = $('#pubToken');

  const btnRawConnect = $('#btnRawConnect');
  const btnPubConnect = $('#btnPubConnect');

  // ---------- 恢复输入 ----------
  window.addEventListener('DOMContentLoaded', () => {
    if (rawUrl)   rawUrl.value   = LS.get('tt_raw_wss_url', rawUrl.value || '');
    if (rawToken) rawToken.value = LS.get('tt_raw_token',   rawToken.value || '');
    if (pubUrl)   pubUrl.value   = LS.get('tt_pub_wss_url', pubUrl.value || '');
    if (pubToken) pubToken.value = LS.get('tt_pub_token',   pubToken.value || '');
  });

  // 输入变更即保存
  ['input','change','blur'].forEach(ev=>{
    rawUrl?.addEventListener(ev,   ()=>LS.set('tt_raw_wss_url', (rawUrl.value||'').trim()));
    rawToken?.addEventListener(ev, ()=>LS.set('tt_raw_token',   (rawToken.value||'').trim()));
    pubUrl?.addEventListener(ev,   ()=>LS.set('tt_pub_wss_url', (pubUrl.value||'').trim()));
    pubToken?.addEventListener(ev, ()=>LS.set('tt_pub_token',   (pubToken.value||'').trim()));
  });

  // ---------- 关键：捕获阶段拦截点击，阻断旧监听 ----------
  function hookConnectButton(btn, buildFinalUrl, which) {
    if (!btn) return;
    // 去掉可能的内联 onclick
    btn.onclick = null;

    btn.addEventListener('click', (e) => {
      // 在捕获阶段就拦截，避免旧脚本的冒泡监听弹窗
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      const {urlField, tokenField, emptyMsg} = buildFinalUrl();
      const raw = (urlField?.value || '').trim();
      if (!raw) {
        // 提示文案改为“地址”，避免和旧脚本提示词完全一致
        alert(emptyMsg);
        urlField?.focus();
        return;
      }

      let finalUrl = normalizeWss(raw);
      const t = (tokenField?.value || '').trim();
      try {
        const u = new URL(finalUrl);
        if (t) u.searchParams.set('token', t);
        finalUrl = u.toString();
      } catch(e) {}

      // 记忆
      if (which === 'src') {
        LS.set('tt_raw_wss_url', raw);
        if (t) LS.set('tt_raw_token', t);
      } else {
        LS.set('tt_pub_wss_url', raw);
        if (t) LS.set('tt_pub_token', t);
      }

      safeConnect(which, finalUrl);
    }, /* useCapture */ true);
  }

  // 原始流按钮
  hookConnectButton(btnRawConnect, () => ({
    urlField: rawUrl,
    tokenField: rawToken,
    emptyMsg: '请填写 原始 WSS 地址'
  }), 'src');

  // 发布按钮（不再强制 token）
  hookConnectButton(btnPubConnect, () => ({
    urlField: pubUrl,
    tokenField: pubToken,
    emptyMsg: '请填写 发布 WSS 地址'
  }), 'pub');

  // 可选：把构建信息写右上角
  const bi = document.getElementById('buildInfo');
  if (bi) bi.textContent = (window.__BUILD_SHA__ || 'dev');
})();
</script>
